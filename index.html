<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hangul Play</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b5fff" />
  <script src="https://unpkg.com/hangul-js@0.2.6"></script>
  <style>
    ::root{
      --primary:#0b5fff; --bg:#f5f7fb; --card:#fff; --text:#0b1020; --muted:#7b869d;
      --key:#fff; --key-bd:#d9e0ff; --shadow:0 6px 16px rgba(15,49,135,.08); --radius:18px;

      /* ë²„íŠ¼ ë†’ì´/ê¸€ê¼´/ê°„ê²©ì„ ë·°í¬íŠ¸ì— ë§ì¶° ìë™ ìŠ¤ì¼€ì¼ */
      --key-height: clamp(72px, 13dvh, 140px);
      --key-font:   clamp(30px, 8vw, 52px);
      --key-gap:    clamp(10px, 2.4dvh, 16px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
    /* í•œ í™”ë©´(ë·°í¬íŠ¸) ì•ˆì— ë‹¤ ë³´ì´ë„ë¡ 3ë‹¨ ê·¸ë¦¬ë“œ: íƒ­ / ìƒë‹¨ / í‚¤ë³´ë“œ */
    .app{height:100dvh;max-width:980px;margin:0 auto;padding:12px;display:grid;grid-template-rows:auto auto 1fr;gap:10px}
    .tabs{display:flex;gap:10px}
    .tab{padding:10px 14px;border-radius:14px;background:#eaf0ff;color:#2d3a7a;font-weight:700;cursor:pointer}
    .tab.is-active{background:var(--primary);color:#fff}
    .top{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .card h4{margin:0 0 6px;color:var(--muted);font-size:13px}
    .target{
      min-height:80px;display:flex;align-items:center;justify-content:center;
      font-size:clamp(42px,9vw,72px);font-weight:800;background:#f2f5ff;border-radius:14px
    }
    .goals{margin-top:6px;color:#57607a;font-weight:600;display:flex;justify-content:space-between;align-items:center}
    .stars{display:flex;gap:6px}.star{filter:grayscale(1) opacity(.5)}.star.on{filter:none}
    /* ë‚´ê°€ ë§Œë“  ê¸€ì: ì¢Œ/ìš° ë°˜ìœ¼ë¡œ ë¶„í• (ììŒ/ëª¨ìŒ) */
    .built-split{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .split-box{
      min-height:80px;background:#f2f5ff;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:clamp(40px,8vw,64px);font-weight:800;position:relative
    }
    .split-box.empty::after{content:"â€¢";color:#9fb1ff}
    .built-actions{display:flex;gap:8px;margin-top:8px}
    .btn{border:none;background:#edf2ff;color:#2d3a7a;padding:9px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn--primary{background:var(--primary);color:#fff}
    /* í‚¤ë³´ë“œ: í•œ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ìŠ¤í¬ë¡¤ ì˜ì—­ */
    /* í‚¤ë³´ë“œë¥¼ ì¢Œ/ìš° ë‘ ì¹¼ëŸ¼ìœ¼ë¡œ */
    .kb-wrap{
      min-height:0;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr; /* ì™¼ìª½ ììŒ / ì˜¤ë¥¸ìª½ ëª¨ìŒ */
      gap:12px;
      overflow:auto;
    }

    /* ê° ì¹¼ëŸ¼ ë‚´ë¶€: ì œëª© + í‚¤ì˜ì—­ */
    .kb-col{
      display:grid;
      grid-template-rows: auto 1fr;
      gap:8px;
      min-height:0;
    }

    .kb-title{ margin:0; color:var(--muted); font-weight:700; font-size:13px }

    /* í‚¤ëŠ” 2ì—´Ã—3í–‰, í„°ì¹˜ í¬ê²Œ */
    .keys{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr)); /* 2ì—´ */
      gap: var(--key-gap);
      grid-auto-rows: var(--key-height);               /* 3í–‰ì´ ë˜ë„ë¡ ìë™ ë†’ì´ */
    }

    .key{
      background:var(--key);
      border:2px solid var(--key-bd);
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      padding:0;
      font-size:var(--key-font);
      font-weight:800;
      line-height:1;
      cursor:pointer; user-select:none; touch-action:manipulation;
      box-shadow:0 2px 0 rgba(0,0,0,.05);
    }
    .key:active{ transform:translateY(1px) }

    /* ì„¸ë¡œí­ì´ ì•„ì£¼ ì¢ì€ ëª¨ë°”ì¼ì—ì„œë„ í•œ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ì•½ê°„ ë” í‚¤ìš°ê¸° */
    @media (max-width:760px){
      .top{ grid-template-columns:1fr }
      :root{
        --key-height: clamp(68px, 15dvh, 136px);
        --key-font:   clamp(28px, 9vw, 50px);
      }
    }
    /* í° í™”ë©´ì—ì„œ ì‚´ì§ í‚¤ìš°ê¸° */
    @media (min-width:1100px){
      :root{
        --key-height: clamp(78px, 10dvh, 140px);
        --key-font:   clamp(32px, 5vw, 54px);
      }
    }

    /* ì¹­ì°¬ ìºë¦­í„° */
    .coach{ display:flex; align-items:center; gap:10px; margin-top:10px }
    .avatar{
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#fff7; box-shadow:var(--shadow); font-size:28px;
    }
    .avatar.pop{ animation:pop .4s ease }
    @keyframes pop{
      0%{ transform:scale(.9) } 50%{ transform:scale(1.12) } 100%{ transform:scale(1) }
    }
    .bubble{
      opacity:0; transform:translateY(6px);
      transition:opacity .25s ease, transform .25s ease;
      background:#fff; padding:8px 12px; border-radius:999px; box-shadow:var(--shadow);
      font-weight:700;
    }
    .bubble.show{ opacity:1; transform:translateY(0) }

  </style>
</head>
<body>
  <main class="app">
    <!-- íƒ­ -->
    <nav class="tabs" aria-label="ëª¨ë“œ ì „í™˜">
      <div class="tab is-active" data-mode="hangul">í•œê¸€</div>
      <div class="tab" data-mode="word">ë‹¨ì–´</div>
      <div class="tab" data-mode="trace">ë”°ë¼ì“°ê¸°</div>
    </nav>

    <!-- ìƒë‹¨: ëª©í‘œ/ë‚´ê°€ ë§Œë“  ê¸€ì -->
    <section class="top">
      <div class="card">
        <h4>ë§Œë“¤ì–´ë³¼ ê¸€ì</h4>
        <div id="targetChar" class="target" aria-live="polite" aria-atomic="true">ê°€</div>
        <div class="goals">
          <span>ì˜¤ëŠ˜ ëª©í‘œ 5ê°œ</span>
          <div id="stars" class="stars"><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span></div>
        </div>
      </div>

      <div class="card">
        <h4>ë‚´ê°€ ë§Œë“  ê¸€ì (ì¢Œ:ììŒ / ìš°:ëª¨ìŒ)</h4>
        <div class="built-split">
          <div id="builtCho" class="split-box empty" aria-label="ì„ íƒëœ ììŒ"></div>
          <div id="builtVow" class="split-box empty" aria-label="ì„ íƒëœ ëª¨ìŒ"></div>
        </div>
        <div class="built-actions">
          <button id="btnClear" class="btn" type="button">ì§€ìš°ê¸°</button>
          <button id="btnShuffle" class="btn" type="button">ìíŒ ì„ê¸°</button>
          <button id="btnNext" class="btn btn--primary" type="button">ë‹¤ìŒ ê¸€ì</button>
        </div>

        <!-- ì¹­ì°¬ ìºë¦­í„° -->
        <div class="coach" aria-live="polite" aria-atomic="true">
          <div class="avatar" title="ì¹­ì°¬ì´">
            ğŸ‘
          </div>
          <div id="praiseBubble" class="bubble" role="status"></div>
        </div>

      </div>
    </section>

    <!-- í‚¤ë³´ë“œ -->
    <!-- í‚¤ë³´ë“œ (ì¢Œ:ììŒ / ìš°:ëª¨ìŒ) -->
    <section class="kb-wrap">
      <div class="kb-col">
        <p class="kb-title">ììŒ</p>
        <div id="conKeys" class="keys" role="group" aria-label="ììŒ í‚¤ë³´ë“œ"></div>
      </div>
      <div class="kb-col">
        <p class="kb-title">ëª¨ìŒ</p>
        <div id="vowKeys" class="keys" role="group" aria-label="ëª¨ìŒ í‚¤ë³´ë“œ"></div>
      </div>
    </section>

  </main>

  <script>
    // ===== ê¸°ë³¸ ë°ì´í„° =====
    const CONSONANTS_BASE = ['ã„±','ã„´','ã„·','ã„¹','ã…','ã…‚','ã……','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
    const VOWELS_BASE     = ['ã…','ã…‘','ã…“','ã…•','ã…—','ã…›','ã…œ','ã… ','ã…¡','ã…£'];
    const JAMO_READ = {'ã„±':'ê¸°ì—­','ã„´':'ë‹ˆì€','ã„·':'ë””ê·¿','ã„¹':'ë¦¬ì„','ã…':'ë¯¸ìŒ','ã…‚':'ë¹„ì','ã……':'ì‹œì˜·','ã…‡':'ì´ì‘','ã…ˆ':'ì§€ì’','ã…Š':'ì¹˜ì“','ã…‹':'í‚¤ì”','ã…Œ':'í‹°ì•','ã…':'í”¼ì','ã…':'íˆì—','ã…':'ì•„','ã…‘':'ì•¼','ã…“':'ì–´','ã…•':'ì—¬','ã…—':'ì˜¤','ã…›':'ìš”','ã…œ':'ìš°','ã… ':'ìœ ','ã…¡':'ìœ¼','ã…£':'ì´'};

    // ===== ì‚¬ìš´ë“œ ìœ í‹¸ =====
    let audioCtx;
    function ensureAudio(){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }catch(e){}
    }
    // ì§§ì€ 'ì‚‘' ì†Œë¦¬
    function beep(freq=850, dur=0.08){
      ensureAudio();
      if(!audioCtx) return;
      const t = audioCtx.currentTime + 0.005;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.22, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t+dur+0.02);
    }

    // TTS(ko-KR) ë³´ì´ìŠ¤ ë¡œë“œ & ì„ íƒ
    let koVoice = null;
    function pickKoVoice(){
      const vs = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      // ko-KR ìš°ì„  â†’ ko í¬í•¨ â†’ ê¸°ë³¸
      koVoice = vs.find(v=>/ko-KR/i.test(v.lang)) || vs.find(v=>/^ko/i.test(v.lang)) || vs[0] || null;
    }
    if ('speechSynthesis' in window){
      pickKoVoice();
      window.speechSynthesis.onvoiceschanged = pickKoVoice;
    }

    function speak(text, {isJamo=false} = {}){
      // í´ë¦­ ì‹œ ì¦‰ì‹œ ë¹„í”„ (í”¼ë“œë°±)
      beep(isJamo ? 820 : 900, 0.07);

      if (!('speechSynthesis' in window)) return; // TTS ë¯¸ì§€ì› í™˜ê²½
      try{
        const msg = new SpeechSynthesisUtterance(isJamo ? (JAMO_READ[text] || text) : text);
        msg.lang = (koVoice && koVoice.lang) || 'ko-KR';
        if (koVoice) msg.voice = koVoice;
        msg.rate = 1.0; msg.pitch = 1.0;
        // íê°€ ê³¼ë„í•˜ê²Œ ìŒ“ì˜€ìœ¼ë©´ ì •ë¦¬
        if (speechSynthesis.pending || speechSynthesis.speaking) speechSynthesis.cancel();
        speechSynthesis.speak(msg);
      }catch(e){}
    }

    function successTone(){
      // ê°„ë‹¨í•œ ì„±ê³µ ë©œë¡œë””
      beep(660, .08);
      setTimeout(()=>beep(880, .09), 120);
      setTimeout(()=>beep(990, .10), 240);
    }

    function praise(){
      const phrases = [
        "ì •ë‹µ! ë„ˆë¬´ ì˜í–ˆì–´ìš” ğŸ‘",
        "í›Œë¥­í•´ìš”! ê³„ì† ê°€ë³¼ê¹Œìš”? âœ¨",
        "ë©‹ì ¸ìš”! ë”©ë™ëŒ• ğŸ‘",
        "ëŒ€ë‹¨í•´ìš” ğŸ˜Š ë‹¤ìŒ ê¸€ìë„ ë„ì „!"
      ];
      const bubble = document.getElementById('praiseBubble');
      const avatar = document.querySelector('.avatar');
      if (!bubble || !avatar) return;

      bubble.textContent = phrases[Math.floor(Math.random()*phrases.length)];
      // ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘ì„ ìœ„í•œ ê°•ì œ ë¦¬í”Œë¡œìš°
      bubble.classList.remove('show'); avatar.classList.remove('pop');
      void bubble.offsetWidth; void avatar.offsetWidth;
      bubble.classList.add('show'); avatar.classList.add('pop');

      successTone();
    }


    // ===== ìƒíƒœ =====
    let target='ê°€', needCho='ã„±', needVow='ã…';
    let selectedCho=null, selectedVow=null;
    let progress=0;

    // ===== ìœ í‹¸ =====
    const $  = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const shuffle = a=>a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(v=>v[1]);
    const choice = a=>a[Math.floor(Math.random()*a.length)];
    function speak(text,{isJamo=false}={}){
      try{
        const u=new SpeechSynthesisUtterance(isJamo?(JAMO_READ[text]||text):text);
        u.lang='ko-KR'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
      }catch(e){}
    }
    function setStars(n){ $$('#stars .star').forEach((st,i)=>st.classList.toggle('on', i<n)); }
    function updateBuiltUI(){
      const c=$('#builtCho'), v=$('#builtVow');
      c.textContent = selectedCho || ''; v.textContent = selectedVow || '';
      c.classList.toggle('empty', !selectedCho); v.classList.toggle('empty', !selectedVow);
    }

    // ===== í‚¤ë³´ë“œ ë Œë” =====
    function renderKeyboard(){
      const conSet=new Set([needCho]), vowSet=new Set([needVow]);
      const conPool=CONSONANTS_BASE.filter(c=>c!==needCho);
      const vowPool=VOWELS_BASE.filter(v=>v!==needVow);
      while(conSet.size<6) conSet.add(choice(conPool));
      while(vowSet.size<6) vowSet.add(choice(vowPool));
      const cons=shuffle([...conSet]), vows=shuffle([...vowSet]);

      const conWrap=$('#conKeys'); conWrap.innerHTML='';
      const vowWrap=$('#vowKeys'); vowWrap.innerHTML='';
      cons.forEach(c=>conWrap.appendChild(makeKey(c,'cho')));
      vows.forEach(v=>vowWrap.appendChild(makeKey(v,'vow')));
    }
    function makeKey(label,type){
      const b=document.createElement('button');
      b.type='button'; b.className='key'; b.textContent=label; b.dataset.type=type;
      b.addEventListener('click', onKeyPress);
      return b;
    }

    // ===== ì…ë ¥(êµì²´ ë°©ì‹) =====
    function onKeyPress(e){
      const val = e.currentTarget.textContent;
      const isCho = e.currentTarget.dataset.type==='cho';
      if(isCho){
        selectedCho = val;          // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ 'êµì²´'
        speak(val,{isJamo:true});
      }else{
        selectedVow = val;          // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ 'êµì²´'
        speak(val,{isJamo:true});
      }
      updateBuiltUI();

      // ììŒ/ëª¨ìŒì´ ëª¨ë‘ ì„ íƒë˜ë©´ ì¡°í•© í›„ ë°œìŒ & ì •ë‹µ íŒì •
      // ììŒ/ëª¨ìŒì´ ëª¨ë‘ ì„ íƒë˜ë©´ ì¡°í•© í›„ ë°œìŒ & ì •ë‹µ íŒì •
      if(selectedCho && selectedVow){
        const assembled = Hangul.assemble([selectedCho, selectedVow]);
        // ì™„ì„± ê¸€ì ë°œìŒ (TTS)
        setTimeout(()=>speak(assembled), 60);

        if(assembled === target){
          praise(); // âœ… ì¹­ì°¬ ì—°ì¶œ + ì„±ê³µ í†¤
          progress = Math.min(5, progress+1);
          setStars(progress);
          setTimeout(nextRound, 420);
        }
      }

    }

    // ===== ë¼ìš´ë“œ ì œì–´ =====
    function clearBuilt(){
      selectedCho=null; selectedVow=null; updateBuiltUI();
    }
    function genTarget(){
      needCho = choice(CONSONANTS_BASE);
      needVow = choice(VOWELS_BASE);
      target  = Hangul.assemble([needCho, needVow]);
      $('#targetChar').textContent = target;
    }
    function nextRound(){
      clearBuilt(); genTarget(); renderKeyboard();
    }

    // íƒ­(ë””ìì¸ë§Œ)
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{$$('.tab').forEach(x=>x.classList.remove('is-active')); t.classList.add('is-active')}));

    // ë²„íŠ¼
    $('#btnClear').addEventListener('click', clearBuilt);
    $('#btnShuffle').addEventListener('click', renderKeyboard);
    $('#btnNext').addEventListener('click', nextRound);

    // ì´ˆê¸°í™”
    setStars(0); nextRound();

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  </script>
</body>
</html>
